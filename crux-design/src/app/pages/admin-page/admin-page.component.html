<div class="main-content">
    <h1 class="page-title">Admin Dashboard</h1>
    
    <div class="admin-controls">
        <button class="add-lesson-btn" (click)="openAddLessonForm()">+ Add Lesson</button>
    </div>
    
    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-state">
        <p>Loading lessons...</p>
    </div>
    
    <!-- Error state -->
    <div *ngIf="!isLoading && hasError" class="error-state">
        <p>{{ errorMessage }}</p>
        <button (click)="fetchLessons()" class="retry-button">Retry</button>
    </div>
    
    <!-- Lessons List for Management -->
    <div *ngIf="!isLoading && !hasError" class="admin-lessons-list">
        <div *ngFor="let lesson of lessons" class="admin-lesson-item">
            <div class="lesson-info">
                <h2>{{ lesson.title }}</h2>
                <p>{{ lesson.cards.length || 0 }} cards</p>
            </div>
            <div class="lesson-actions">
                <button class="action-btn edit-btn" (click)="editLesson(lesson)">Edit</button>
                <button class="action-btn view-cards-btn" (click)="viewCards(lesson)">View Cards</button>
                <button class="action-btn delete-btn" (click)="deleteLesson(lesson)">Delete</button>
            </div>
        </div>
        
        <!-- No lessons message -->
        <div *ngIf="lessons.length === 0" class="no-data">
            <p>No lessons available. Create your first lesson with the "Add Lesson" button above.</p>
        </div>
    </div>
    
    <!-- Add Lesson Popup -->
    <div *ngIf="isAddLessonPopupVisible" class="add-lesson-popup-overlay" (click)="closeAddLessonPopup($event)">
        <div class="add-lesson-popup-content">
            <div class="popup-header">
                <h2>Add New Lesson</h2>
                <button class="close-popup-btn" (click)="closeAddLessonPopup($event)">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label for="lessonName">Lesson Name</label>
                    <input type="text" id="lessonName" [(ngModel)]="newLessonName" 
                           placeholder="Enter lesson name" class="form-control">
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="cancel-btn" (click)="closeAddLessonPopup($event)">Cancel</button>
                <button class="create-btn" [disabled]="!newLessonName.trim()" 
                        (click)="createLesson()">Create Lesson</button>
            </div>
        </div>
    </div>
    
    <!-- Cards Popup -->
    <div *ngIf="selectedLesson && isCardsPopupVisible" class="cards-popup-overlay" (click)="closeCardsPopup($event)">
        <div class="cards-popup-content">
            <div class="popup-header">
                <h2>Cards in "{{ selectedLesson.title }}"</h2>
                <button class="close-popup-btn" (click)="closeCardsPopup($event)">&times;</button>
            </div>
            
            <div class="cards-container">
                <div *ngIf="selectedLesson.cards.length === 0" class="no-cards-message">
                    <p>No cards available in this lesson.</p>
                    <button class="add-card-btn" (click)="addCardToLesson(selectedLesson)">+ Add Card</button>
                </div>
                
                <div *ngFor="let card of selectedLesson.cards" class="admin-card-item" [ngClass]="getCardTypeClass(card.type)">
                    <div class="card-header">
                        <h3>{{ card.title }}</h3>
                        <span class="card-type-badge">{{ card.type }}</span>
                    </div>
                    <p class="card-description">{{ card.description }}</p>
                    <div class="card-actions">
                        <button class="card-action-btn edit-btn" (click)="editCard(card)">Edit</button>
                        <button class="card-action-btn delete-btn" (click)="deleteCard(card)">Delete</button>
                    </div>
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="add-card-btn" (click)="addCardToLesson(selectedLesson)">+ Add Card</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Card Popup - moved to the end to ensure it's rendered on top -->
<div *ngIf="isAddCardPopupVisible" class="add-card-popup-overlay" (click)="closeAddCardPopup($event)">
    <div class="add-card-popup-content">
        <div class="popup-header">
            <h2>Add New Card</h2>
            <button class="close-popup-btn" (click)="closeAddCardPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <!-- Debug info to verify popup state -->
            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                Editing lesson: {{ currentLessonForCard?.title }}
            </p>
            
            <div class="form-group">
                <label for="cardTitle">Card Title</label>
                <input type="text" id="cardTitle" [(ngModel)]="newCard.title" 
                       placeholder="Enter card title" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="cardDescription">Card Description</label>
                <textarea id="cardDescription" [(ngModel)]="newCard.description" 
                        placeholder="Enter card description" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="cardType">Card Type</label>
                <select id="cardType" [(ngModel)]="newCard.type" class="form-control">
                    <option value="Educational">Educational</option>
                    <option value="Test">Test</option>
                    <option value="Sandbox">Sandbox</option>
                </select>
            </div>
            
            <!-- Add sandbox type selection when Sandbox is selected -->
            <div class="form-group" *ngIf="newCard.type === 'Sandbox'">
                <label for="sandBoxCardType">Sandbox Type</label>
                <select id="sandBoxCardType" [(ngModel)]="newCard.sandBoxCardType" class="form-control">
                    <option value="Primitives">Primitives</option>
                    <option value="Bezier">Bezier</option>
                    <option value="FractalSystem">Fractal System</option>
                    <option value="ColorSystem">Color System</option>
                </select>
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="cancel-btn" (click)="closeAddCardPopup($event)">Cancel</button>
            <button class="create-btn" [disabled]="!isCardFormValid()" 
                    (click)="createCard()">Create Card</button>
        </div>
    </div>
</div>

<!-- Test Questions List Popup -->
<div *ngIf="isViewTestQuestionsPopupVisible" class="view-test-questions-overlay" (click)="closeViewTestQuestionsPopup($event)">
    <div class="view-test-questions-content">
        <div class="popup-header">
            <h2>Questions in "{{ currentEditingCard?.title }}"</h2>
            <button class="close-popup-btn" (click)="closeViewTestQuestionsPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <!-- Loading state for questions -->
            <div *ngIf="isLoadingQuestions" class="loading-state">
                <p>Loading questions...</p>
            </div>
            
            <!-- Questions list -->
            <div *ngIf="!isLoadingQuestions" class="questions-list">
                <div *ngIf="testQuestions.length === 0" class="no-questions-message">
                    <p>No questions available for this test.</p>
                </div>
                
                <div *ngFor="let question of testQuestions; let i = index" class="question-item">
                    <div class="question-header">
                        <h3>Question #{{i+1}}</h3>
                    </div>
                    <p class="question-text">{{ question.questionText }}</p>
                    <div class="answer-count">{{ question.answers.length || 0 }} answers</div>
                    <div class="question-actions">
                        <button class="action-btn edit-btn" (click)="editQuestion(question)">Edit</button>
                        <button class="action-btn delete-btn" (click)="deleteQuestion(question, i)">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="add-question-btn" (click)="addNewQuestion()">+ Add Question</button>
        </div>
    </div>
</div>

<!-- Test Card Edit Popup -->
<div *ngIf="isEditTestCardPopupVisible" class="edit-test-card-popup-overlay" (click)="closeEditTestCardPopup($event)">
    <div class="edit-test-card-popup-content">
        <div class="popup-header">
            <h2 class="popup-title">{{ questionPopupTitle }}</h2>
            <button class="close-popup-btn" (click)="closeEditTestCardPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <div class="form-group">
                <label for="questionText">Question</label>
                <textarea id="questionText" [(ngModel)]="testCardData.questionText" 
                        placeholder="Enter question text" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="answers-section">
                <h3>Answers</h3>
                <div *ngFor="let answer of testCardData.answers; let i = index" class="answer-item">
                    <div class="answer-header">
                        <h4>Answer #{{i+1}}</h4>
                        <button type="button" class="remove-answer-btn" (click)="removeAnswer(i)">Remove</button>
                    </div>
                    
                    <div class="form-group">
                        <label [for]="'answerText' + i">Answer Text</label>
                        <input [id]="'answerText' + i" [(ngModel)]="answer.answerText" 
                               placeholder="Enter answer text" class="form-control">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label [for]="'answerScore' + i">Score</label>
                            <input [id]="'answerScore' + i" type="number" [(ngModel)]="answer.score" 
                                   placeholder="Points for this answer" class="form-control"
                                   [disabled]="answer.isCorrect">
                        </div>
                        
                        <div class="form-group half-width radio-group">
                            <label>
                                <input type="radio" name="correctAnswer" [value]="i" 
                                       [checked]="answer.isCorrect"
                                       (change)="setCorrectAnswer(i)">
                                Correct Answer
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-answer-btn" (click)="addAnswer()">+ Add Answer</button>
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="cancel-btn" (click)="closeEditTestCardPopup($event)">Cancel</button>
            <button type="button" 
                    class="save-btn" 
                    [disabled]="!isTestCardFormValid()" 
                    (click)="saveTestCard()">
                {{ questionPopupSubmitText }}
            </button>
        </div>
    </div>
</div>

<!-- Add Edit Card Popup -->
<div *ngIf="isEditCardPopupVisible" class="edit-card-popup-overlay" (click)="closeEditCardPopup($event)">
    <div class="edit-card-popup-content">
        <div class="popup-header">
            <h2 class="popup-title">{{ questionPopupTitle }}</h2>
            <button class="close-popup-btn" (click)="closeEditCardPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <div class="form-group">
                <label for="cardTitle">Card Title</label>
                <input type="text" id="cardTitle" [(ngModel)]="editedCardData.title" 
                       placeholder="Enter card title" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="cardDescription">Card Description</label>
                <textarea id="cardDescription" [(ngModel)]="editedCardData.description" 
                        placeholder="Enter card description" class="form-control" rows="3"></textarea>
            </div>
            
            <!-- Optional: Add additional content based on card type -->
            <div *ngIf="cardBeingEdited?.type === 'Test'" class="edit-test-questions">
                <button class="edit-questions-btn" (click)="editTestCardQuestions(cardBeingEdited!)">
                    Edit Test Questions
                </button>
                <p class="help-text">Click to edit the test questions for this card.</p>
            </div>
            
            <div *ngIf="cardBeingEdited?.type === 'Educational'" class="edit-educational-data">
                <button class="edit-educational-btn" (click)="editEducationalData(cardBeingEdited!)">
                    Edit Educational Content
                </button>
                <p class="help-text">Click to edit the educational content for this card.</p>
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="cancel-btn" (click)="closeEditCardPopup($event)">Cancel</button>
            <button class="save-btn" [disabled]="!isEditCardFormValid()" 
                    (click)="saveEditedCard()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Educational Content Edit Popup (Enhanced) -->
<div *ngIf="isViewEducationalContentPopupVisible" class="view-educational-content-overlay" (click)="closeEducationalContentPopup($event)">
    <div class="view-educational-content">
        <div class="popup-header">
            <h2>Edit Educational Content for "{{ currentEditingCard?.title }}"</h2>
            <button class="close-popup-btn" (click)="closeEducationalContentPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <!-- Loading state for content -->
            <div *ngIf="isLoadingEducationalContent" class="loading-spinner">
                <div class="spinner"></div>
                <p>Loading content...</p>
            </div>
            
            <div *ngIf="!isLoadingEducationalContent" class="educational-editor-container">
                <div class="educational-content-form">
                    <div class="content-section">
                        <h3>HTML Content</h3>
                        
                        <div class="editor-toolbar">
                            <button type="button" class="toolbar-btn" title="Heading 1" (click)="insertHeader(1)">H1</button>
                            <button type="button" class="toolbar-btn" title="Heading 2" (click)="insertHeader(2)">H2</button>
                            <button type="button" class="toolbar-btn" title="Heading 3" (click)="insertHeader(3)">H3</button>
                            <button type="button" class="toolbar-btn" title="Paragraph" (click)="insertHtmlTag('<p>', '</p>')">P</button>
                            <button type="button" class="toolbar-btn" title="Bold" (click)="insertBold()"><strong>B</strong></button>
                            <button type="button" class="toolbar-btn" title="Italic" (click)="insertItalic()"><em>I</em></button>
                            <button type="button" class="toolbar-btn" title="Unordered List" (click)="insertHtmlTag('<ul>\n  <li>', '</li>\n</ul>')">List</button>
                            <button type="button" class="toolbar-btn" title="List Item" (click)="insertHtmlTag('<li>', '</li>')">List Item</button>
                            <button type="button" class="toolbar-btn" title="Code Block" (click)="insertHtmlTag('<pre><code>', '</code></pre>')">Code</button>
                            <button type="button" class="toolbar-btn" title="Insert Link" (click)="insertLink()">Link</button>
                            <button type="button" class="toolbar-btn" title="Insert Image" (click)="insertImage()">Image</button>
                        </div>
                        
                        <textarea 
                            class="html-editor form-control" 
                            [(ngModel)]="educationalContent" 
                            (ngModelChange)="onContentChange()"
                            placeholder="Enter HTML content here"></textarea>
                        
                        <div *ngIf="educationalContent" class="content-preview-section">
                            <h4>Preview:</h4>
                            <div class="content-preview" [innerHTML]="educationalContent | sanitizeHtml"></div>
                        </div>
                    </div>

                    <!-- Images Section -->
                    <div class="content-section images-section">
                        <div class="section-header">
                            <h3>Images</h3>
                            <button type="button" class="add-btn" (click)="addImage()">+ Add Image</button>
                        </div>
                        
                        <div *ngIf="educationalImages.length === 0" class="no-items-message">
                            <p>No images added. Use the "Add Image" button to include images.</p>
                        </div>
                        
                        <div *ngFor="let image of educationalImages; let i = index" class="image-item">
                            <div class="item-header">
                                <h4>Image #{{ i + 1 }}</h4>
                                <button type="button" class="remove-btn" (click)="removeImage(i)">Remove</button>
                            </div>
                            
                            <div class="form-row">
                                <label for="image-url-{{ i }}">Image URL</label>
                                <input type="text" id="image-url-{{ i }}" [(ngModel)]="image.url" placeholder="Enter image URL" class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <label for="image-caption-{{ i }}">Caption</label>
                                <input type="text" id="image-caption-{{ i }}" [(ngModel)]="image.caption" placeholder="Enter image caption" class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <label for="image-alt-{{ i }}">Alt Text</label>
                                <input type="text" id="image-alt-{{ i }}" [(ngModel)]="image.altText" placeholder="Enter alt text for accessibility" class="form-control">
                            </div>
                            
                            <!-- Update the image preview section to use original URLs when available -->
                            <div *ngIf="image.url || originalImageUrls[i]" class="image-preview">
                                <img [src]="image.url || originalImageUrls[i]" [alt]="image.altText || 'Preview'" style="max-width: 100%; max-height: 150px;">
                                <div *ngIf="originalImageUrls[i] && !image.url" class="original-image-note">
                                    (Using original image - enter new URL to change)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attachments Section -->
                    <div class="content-section attachments-section">
                        <div class="section-header">
                            <h3>Attachments</h3>
                            <button type="button" class="add-btn" (click)="addAttachment()">+ Add Attachment</button>
                        </div>
                        
                        <div *ngIf="educationalAttachments.length === 0" class="no-items-message">
                            <p>No attachments added. Use the "Add Attachment" button to include downloadable files.</p>
                        </div>
                        
                        <div *ngFor="let attachment of educationalAttachments; let i = index" class="attachment-item">
                            <div class="item-header">
                                <h4>Attachment #{{ i + 1 }}</h4>
                                <button type="button" class="remove-btn" (click)="removeAttachment(i)">Remove</button>
                            </div>
                            
                            <div class="form-row">
                                <label for="attachment-url-{{ i }}">File URL</label>
                                <input type="text" id="attachment-url-{{ i }}" [(ngModel)]="attachment.url" placeholder="Enter file URL" class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <label for="attachment-desc-{{ i }}">Description</label>
                                <input type="text" id="attachment-desc-{{ i }}" [(ngModel)]="attachment.description" placeholder="Enter file description" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="cancel-btn" (click)="closeEducationalContentPopup($event)">Cancel</button>
            <button class="save-btn" (click)="saveEducationalContent()">Save Content</button>
        </div>
    </div>
</div>

<!-- Edit Lesson Popup -->
<div *ngIf="isEditLessonPopupVisible" class="edit-lesson-popup-overlay" (click)="closeEditLessonPopup($event)">
    <div class="edit-lesson-popup-content">
        <div class="popup-header">
            <h2>Edit Lesson</h2>
            <button class="close-popup-btn" (click)="closeEditLessonPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <div class="form-group">
                <label for="editLessonName">Lesson Name</label>
                <input type="text" id="editLessonName" [(ngModel)]="editedLessonName" 
                       placeholder="Enter lesson name" class="form-control">
            </div>
        </div>
        
        <div class="popup-footer">
            <button class="cancel-btn" (click)="closeEditLessonPopup($event)">Cancel</button>
            <button class="save-btn" [disabled]="!editedLessonName.trim()" 
                    (click)="saveEditedLesson()">Save Changes</button>
        </div>
    </div>
</div>

<!-- View Tasks Popup -->
<div *ngIf="isViewTasksPopupVisible" class="view-tasks-overlay" (click)="closeViewTasksPopup($event)">
    <div class="popup-content">
        <div class="popup-header">
            <h2>Tasks for {{ currentEditingCard?.title }}</h2>
            <button class="close-popup-btn" (click)="closeViewTasksPopup($event)">&times;</button>
        </div>
        
        <div class="popup-body">
            <div *ngIf="isLoadingTasks" class="loading-message">
                Loading tasks...
            </div>
            
            <div *ngIf="!isLoadingTasks">
                <div class="action-buttons">
                    <button class="primary-btn">+ Add New Task</button>
                </div>
                
                <div *ngIf="tasks.length === 0" class="no-items-message">
                    No tasks found. Click "Add New Task" to create one.
                </div>
                
                <div *ngIf="tasks.length > 0" class="items-list">
                    <div *ngFor="let task of tasks; let i = index" class="item-card">
                        <div class="item-info">
                            <h3>{{ task.name }}</h3>
                            <p>{{ task.description }}</p>
                            <div class="item-details">
                                <span class="detail-badge">Points: {{ task.points }}</span>
                                <span class="detail-badge" *ngIf="task.isCompleted !== null && task.isCompleted !== undefined">
                                    Status: {{ task.isCompleted ? 'Completed' : 'Not Completed' }}
                                </span>
                                <span class="detail-badge" *ngIf="task.expectedDataType">
                                    Type: {{ task.expectedDataType }}
                                </span>
                                <span class="detail-badge" *ngIf="task.expectedDataCount">
                                    Count: {{ task.expectedDataCount }}
                                </span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="edit-btn" >Edit</button>
                            <button class="delete-btn" >Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

