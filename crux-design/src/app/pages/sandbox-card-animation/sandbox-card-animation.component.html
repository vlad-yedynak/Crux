<div *ngIf="!showAuthMessage">
  <div class="mobile-warning">
    <p>–¶—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö —á–µ—Ä–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—ñ.</p>
    <p>–ë—É–¥—å –ª–∞—Å–∫–∞, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ —ó—ó –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º—É –∫–æ–º–ø'—é—Ç–µ—Ä—ñ.</p>
  </div>
  <div *ngIf="card?.sandboxType === 'Animation'" class="sandbox-layout-container desktop-only-content">
    <div class="canvas-section">
      <div #canvasContainer id="canvasContainer">
        <canvas #myCanvas id="coordinateCanvas"></canvas>
      </div>
    </div>
    <div class="overlay-section">
      <div class="overlay-navigation">
        <button [ngClass]="{'active': activePanel === 'shapes'}" (click)="switchPanel('shapes')">–§—ñ–≥—É—Ä–∏</button>
        <button [ngClass]="{'active': activePanel === 'tasks'}" (click)="switchPanel('tasks')">–ó–∞–≤–¥–∞–Ω–Ω—è</button>
        <button [ngClass]="{'active': activePanel === 'animations'}" (click)="switchPanel('animations')">–ê–Ω—ñ–º–∞—Ü—ñ—ó</button>
      </div>

      <!-- Shapes panel -->
      <div class="panel" *ngIf="activePanel === 'shapes'">
        <div class="shape-selector">
          <h4>–û–±–µ—Ä—ñ—Ç—å —Ñ—ñ–≥—É—Ä—É:</h4>
          <select id="shape" name="shape" [(ngModel)]="selectedShapeType">
            <option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option>
            <option value="triangle">–¢—Ä–∏–∫—É—Ç–Ω–∏–∫</option>
            <option value="rectangle">–ü—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫</option> 
            <option value="circle">–ö—Ä—É–≥</option> 
            <option value="polygon">–Ü–Ω—à–∏–π –±–∞–≥–∞—Ç–æ–∫—É—Ç–Ω–∏–∫</option>
          </select>
        </div>
        <button class="draw-button" (click)="onDrawShape()">–ù–∞–º–∞–ª—é–≤–∞—Ç–∏</button>

        <div class="drawn-shapes-list">
          <h4>–ù–∞–º–∞–ª—å–æ–≤–∞–Ω—ñ —Ñ—ñ–≥—É—Ä–∏:</h4>
          <ul *ngIf="drawnShapes.length > 0; else noShapes">
            <li *ngFor="let shape of drawnShapes; let i = index">
              <div class="shape-info" (click)="onEditShape(shape)">
                <span>{{ i + 1 }}. {{ shape.name || shape.type }} {{ shape.isPlaceholder ? '(—Ä–µ–¥–∞–≥—É—î—Ç—å—Å—è)' : '' }}</span>
              </div>
              <div class="shape-actions">
                <button class="edit-arrow-btn" (click)="onEditShape(shape)" [class.open]="shape.id === editingShapeId">
                  <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 24 24">
                    <path d="M7 10l5 5 5-5H7z" fill="currentColor" />
                  </svg>
                </button>
                <button class="delete-cross-btn" (click)="onDeleteShape(shape.id)">
                  <svg class="cross-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                  </svg>
                </button>
              </div>
              <div class="shape-edit-panel" *ngIf="shape.id === editingShapeId" @slideTogglePanel>
                <div class="name-section">
                  <label>–ù–∞–∑–≤–∞ —Ñ—ñ–≥—É—Ä–∏:</label>
                  <input 
                    type="text" 
                    [(ngModel)]="shape.name" 
                    (input)="updateShapeProperty('name', shape.name)"
                  >
                </div>
                
                <div class="color-section">
                  <label>–ö–æ–ª—ñ—Ä –∑–∞–ª–∏–≤–∫–∏:</label>
                  <input 
                    type="color" 
                    [(ngModel)]="shape.fillColor" 
                    (change)="updateShapeProperty('fillColor', shape.fillColor)"
                  >
                </div>
                
                <div class="color-section">
                  <label>–ö–æ–ª—ñ—Ä –∫–æ–Ω—Ç—É—Ä—É:</label>
                  <input 
                    type="color" 
                    [(ngModel)]="shape.borderColor" 
                    (change)="updateShapeProperty('borderColor', shape.borderColor)"
                  >
                </div>
                
                <div class="points-section">
                  <div class="points-header-container">
                    <div class="points-header">
                      <span *ngIf="shape.type !== 'circle' && shape.type !== 'polygon'">–¢–æ—á–∫–∏ (–ø–æ—Ç—Ä—ñ–±–Ω–æ: {{ getRequiredPointsCount(shape.type) }}, –º–∞—î–º–æ: {{ shape.points.length }}):</span>
                      <span *ngIf="shape.type === 'polygon'">–¢–æ—á–∫–∏ (–ø–æ—Ç—Ä—ñ–±–Ω–æ —â–æ–Ω–∞–π–º–µ–Ω—à–µ: {{ getRequiredPointsCount(shape.type) }}, –º–∞—î–º–æ: {{ shape.points.length }}):</span>
                      <span *ngIf="shape.type === 'circle'">–¶–µ–Ω—Ç—Ä:</span>
                    </div>
                    <button *ngIf="shape.type !== 'circle'" type="button" class="add-point-btn" (click)="addPointToShape(shape)">
                      <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/>
                      </svg>
                      –î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É
                    </button>
                  </div>
              
                  <!-- Point inputs for Polygons -->
                  <div *ngIf="shape.type !== 'circle'" class="points-container">
                    <div *ngFor="let point of shape.points; let i = index" class="point-inputs" [ngClass]="{'invalid-point': !isPointValid(shape.id, i)}">
                      <div class="point-header">
                        <span class="point-label">–¢–æ—á–∫–∞ {{ i + 1 }}:</span>
                        <button type="button" class="remove-point-btn" (click)="removePointFromShape(shape, i)">
                          <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                          </svg>
                        </button>
                      </div>
                      <div class="coordinates">
                        <div class="coordinate">
                          <label for="point-{{i}}-x">X:</label>
                          <input 
                            type="number" 
                            id="point-{{i}}-x" 
                            [(ngModel)]="shape.points[i].x" 
                            (input)="updateShapeProperty('point-'+i+'-x', shape.points[i].x)"
                            [ngClass]="{'invalid-input': !isPointValid(shape.id, i)}"
                            step="1.0"
                          >
                        </div>
                        <div class="coordinate">
                          <label for="point-{{i}}-y">Y:</label>
                          <input 
                            type="number" 
                            id="point-{{i}}-y" 
                            [(ngModel)]="shape.points[i].y" 
                            (input)="updateShapeProperty('point-'+i+'-y', shape.points[i].y)"
                            [ngClass]="{'invalid-input': !isPointValid(shape.id, i)}"
                            step="1.0"
                          >
                        </div>
                      </div>
                      <div *ngIf="!isPointValid(shape.id, i)" class="point-validation-error">
                        –¶—è —Ç–æ—á–∫–∞ –Ω–µ —É—Ç–≤–æ—Ä—é—î –ø—Ä–∞–≤–∏–ª—å–Ω—É —Ñ—ñ–≥—É—Ä—É
                      </div>
                    </div>
                    <div *ngIf="shape.points.length === 0 && shape.type !== 'circle'" class="no-points-message">
                      –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É", —â–æ–± –¥–æ–¥–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è —Ñ—ñ–≥—É—Ä–∏
                    </div>
                  </div>

                  <div *ngIf="shape.type === 'circle'" class="points-container">
                    <div *ngIf="shape.points.length > 0" class="point-inputs" [ngClass]="{'invalid-point': !isPointValid(shape.id, 0)}">
                      <div class="point-header">
                        <span class="point-label">–¶–µ–Ω—Ç—Ä (X, Y):</span>
                      </div>
                      <div class="coordinates">
                        <div class="coordinate">
                          <label for="circle-center-x-{{shape.id}}">X:</label>
                          <input 
                            type="number" 
                            id="circle-center-x-{{shape.id}}" 
                            [(ngModel)]="shape.points[0].x" 
                            (input)="updateShapeProperty('point-0-x', shape.points[0].x)"
                            [ngClass]="{'invalid-input': !isPointValid(shape.id, 0) && shape.points.length > 0}"
                            step="1.0"
                          >
                        </div>
                        <div class="coordinate">
                          <label for="circle-center-y-{{shape.id}}">Y:</label>
                          <input 
                            type="number" 
                            id="circle-center-y-{{shape.id}}" 
                            [(ngModel)]="shape.points[0].y" 
                            (input)="updateShapeProperty('point-0-y', shape.points[0].y)"
                            [ngClass]="{'invalid-input': !isPointValid(shape.id, 0) && shape.points.length > 0}"
                            step="1.0"
                          >
                        </div>
                      </div>
                    </div>
                    <!-- Radius Input -->
                    <div class="point-inputs" [ngClass]="{'invalid-point': shape.radius !== undefined && shape.radius <= 0}">
                        <div class="point-header">
                            <span class="point-label">–†–∞–¥—ñ—É—Å:</span>
                        </div>
                        <div class="coordinates">
                            <div class="coordinate">
                                <label for="circle-radius-{{shape.id}}">R:</label>
                                <input 
                                  type="number" 
                                  id="circle-radius-{{shape.id}}" 
                                  [(ngModel)]="shape.radius" 
                                  (input)="updateShapeProperty('radius', shape.radius)"
                                  min="0.1" 
                                  step="0.1"
                                  [ngClass]="{'invalid-input': shape.radius !== undefined && shape.radius <= 0}"
                                >
                            </div>
                        </div>
                        <div *ngIf="shape.radius !== undefined && shape.radius <= 0" class="point-validation-error">
                          –†–∞–¥—ñ—É—Å –º–∞—î –±—É—Ç–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–º —á–∏—Å–ª–æ–º.
                        </div>
                    </div>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button type="button" class="save-btn" 
                    [disabled]="!isShapeValid(shape)" 
                    (click)="onSaveShape()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                  <button type="button" class="cancel-btn" (click)="onCancelEditShape()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </div>
              
                <div *ngIf="shape.points.length !== getRequiredPointsCount(shape.type) && shape.type !== 'circle' && shape.type !== 'polygon'" class="validation-error">
                  –î–ª—è —Ñ—ñ–≥—É—Ä–∏ "{{ shape.type === 'square' ? '–∫–≤–∞–¥—Ä–∞—Ç' : shape.type === 'triangle' ? '—Ç—Ä–∏–∫—É—Ç–Ω–∏–∫' : '–ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫' }}" –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ç–æ—á–Ω–æ
                  {{ getRequiredPointsCount(shape.type) }} —Ç–æ—á–∫–∏
                </div>
                <div *ngIf="shape.type === 'polygon' && shape.points.length < getRequiredPointsCount(shape.type)" class="validation-error">
                  –î–ª—è —Ñ—ñ–≥—É—Ä–∏ "–±–∞–≥–∞—Ç–æ–∫—É—Ç–Ω–∏–∫" –ø–æ—Ç—Ä—ñ–±–Ω–æ —â–æ–Ω–∞–π–º–µ–Ω—à–µ {{ getRequiredPointsCount(shape.type) }} —Ç–æ—á–∫–∏.
                </div>
                 <div *ngIf="shape.type === 'circle' && (shape.radius === undefined || shape.radius <= 0)" class="validation-error">
                  –†–∞–¥—ñ—É—Å –¥–ª—è –∫—Ä—É–≥–∞ –º–∞—î –±—É—Ç–∏ –≤–∫–∞–∑–∞–Ω–∏–π —ñ –±—É—Ç–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–º.
                </div>
              </div>
            </li>
          </ul>
          <ng-template #noShapes>
            <p class="no-shapes-message">–©–µ –Ω–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ –∂–æ–¥–Ω–æ—ó —Ñ—ñ–≥—É—Ä–∏.</p>
          </ng-template>
        </div>
      </div>

      <!-- Tasks panel -->
      <div class="panel" *ngIf="activePanel === 'tasks'">
        <div class="task-section">
          <div *ngIf="!selectedTask" class="task-list">
            <h4>–°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å:</h4>
            <ul *ngIf="card && card.tasks && card.tasks.length > 0; else noTasks">
              <li *ngFor="let task of card?.tasks" (click)="selectTask(task)" [ngClass]="{'completed-task': task.isCompleted}">
                <div class="shape-info">
                  <span>{{ task.name }}</span>
                </div>
                <div class="task-status" *ngIf="task.isCompleted">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" class="completed-icon">
                    <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                  </svg>
                  <span class="completed-text">–í–∏–∫–æ–Ω–∞–Ω–æ</span>
                </div>
              </li>
            </ul>
            <ng-template #noTasks>
              <p class="no-shapes-message">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å.</p>
            </ng-template>
          </div>
          <div *ngIf="selectedTask" class="task-details shape-edit-panel" [ngClass]="{'completed-task': selectedTask.isCompleted}">
            <div class="name-section">
              <label>–ó–∞–≤–¥–∞–Ω–Ω—è:</label>
              <h4>{{ selectedTask.name }}</h4>
            </div>
            
            <div class="points-section">
              <div class="points-header">–û–ø–∏—Å:</div>
              <p class="task-description">{{ selectedTask.description }}</p>
            </div>
            
            <div class="points-section">
              <div class="points-header">–í—ñ–¥–ø–æ–≤—ñ–¥—å:</div>
              
              <div *ngIf="selectedTask.expectedDataType && selectedTask.expectedDataCount && selectedTask.expectedDataType.length >= selectedTask.expectedDataCount; else noExpectedData">
                <ng-container *ngFor="let dataType of selectedTask.expectedDataType; let idx = index">
                  <div *ngIf="idx < selectedTask.expectedDataCount" class="point-inputs">
                    <div class="point-header">
                      <span class="point-label">{{ getDataTypeLabel(dataType) }}:</span>
                    </div>
                    <div class="coordinates">
                      <div class="coordinate" style="width: 100%;">
                        <input 
                          *ngIf="dataType.toLowerCase() !== 'bool'"
                          [type]="getInputType(dataType)" 
                          [(ngModel)]="taskAnswers[idx]"
                          [placeholder]="getPlaceholder(dataType)"
                          [step]="dataType.toLowerCase() === 'double' ? '0.01' : (dataType.toLowerCase() === 'int' ? '1' : null)"
                          class="task-input-field" 
                        />
                        <select *ngIf="dataType.toLowerCase() === 'bool'" [(ngModel)]="taskAnswers[idx]" class="task-input-field">
                          <option [ngValue]="undefined">–û–±–µ—Ä—ñ—Ç—å...</option>
                          <option value="true">–ü—Ä–∞–≤–¥–∞ (True)</option>
                          <option value="false">–ù–µ–ø—Ä–∞–≤–¥–∞ (False)</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>
              <ng-template #noExpectedData>
                <p class="no-shapes-message">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ—á—ñ–∫—É–≤–∞–Ω—ñ —Ç–∏–ø–∏ –¥–∞–Ω–∏—Ö –¥–ª—è —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—è –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞.</p>
              </ng-template>
            </div>
            
            <div class="form-actions">
              <button class="save-btn" (click)="submitTaskAnswer()" [disabled]="selectedTask.isCompleted">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
              <button class="cancel-btn" (click)="deselectTask()">–ù–∞–∑–∞–¥</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Animations panel -->
      <div class="panel" *ngIf="activePanel === 'animations'">
        <div class="animation-section">
          <h4>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—è–º–∏:</h4>
          
          <!-- Shape selection for animation -->
          <div class="shape-selector" *ngIf="!selectedAnimationShapeId">
            <h5>–û–±–µ—Ä—ñ—Ç—å —Ñ—ñ–≥—É—Ä—É –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó:</h5>
            <ul *ngIf="getNonPlaceholderShapes().length > 0; else noShapesForAnimation">
              <li *ngFor="let shape of getNonPlaceholderShapes()" 
                  (click)="selectShapeForAnimation(shape.id)" 
                  class="shape-info clickable">
                <span>{{ shape.name || shape.type }}</span>
                <span *ngIf="shape.animation" class="animation-indicator">üé¨</span>
              </li>
            </ul>
            <ng-template #noShapesForAnimation>
              <p class="no-shapes-message">–°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–ª—é–π—Ç–µ —Ñ—ñ–≥—É—Ä–∏ —É –≤–∫–ª–∞–¥—Ü—ñ "–§—ñ–≥—É—Ä–∏".</p>
            </ng-template>
          </div>

          <!-- Animation editor -->
          <div *ngIf="selectedAnimationShapeId" class="animation-editor">
            <div class="animation-header">
              <h5>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—ó: {{ getSelectedShapeName() }}</h5>
              <button class="cancel-btn" (click)="selectedAnimationShapeId = null">–ù–∞–∑–∞–¥</button>
            </div>

            <!-- Animation settings -->
            <div class="animation-settings">
              <div class="setting-row">
                <label for="animDuration">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Å–µ–∫):</label>
                <input type="number" id="animDuration" [(ngModel)]="animationDuration" min="0.1" step="0.1">
              </div>
              <div class="setting-row">
                <label for="animLoop">–¶–∏–∫–ª—ñ—á–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è:</label>
                <input type="checkbox" id="animLoop" [(ngModel)]="animationLoop">
              </div>
            </div>

            <!-- Keyframes editor -->
            <div class="keyframes-section">
              <div class="keyframes-header">
                <h6>–ö–ª—é—á–æ–≤—ñ –∫–∞–¥—Ä–∏:</h6>
                <button class="add-point-btn" (click)="addKeyframe()">
                  <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/>
                  </svg>
                  –î–æ–¥–∞—Ç–∏ –∫–∞–¥—Ä
                </button>
              </div>

              <div class="keyframes-list">
                <div *ngFor="let keyframe of keyframes; let i = index" class="keyframe-item">
                  <div class="keyframe-header" (click)="editKeyframe(i)">
                    <span>–ö–∞–¥—Ä {{ i + 1 }} ({{ keyframe.time }}—Å)</span>
                    <div class="keyframe-actions">
                      <button class="delete-cross-btn" (click)="removeKeyframe(i)" [disabled]="keyframes.length <= 1">
                        <div>
                          <svg class="cross-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                          </svg>
                        </div>
                      </button>
                    </div>
                  </div>

                  <div *ngIf="editingKeyframeIndex === i" class="keyframe-editor" @slideTogglePanel>
                    <div class="transform-section">
                      <label>–ß–∞—Å (—Å–µ–∫):</label>
                      <input type="number" [ngModel]="keyframe.time" 
                             (input)="onKeyframeTimeChange(i, $event)" 
                             min="0" [max]="animationDuration" step="0.1">
                    </div>

                    <div class="transform-section">
                      <label>–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è:</label>
                      <div class="coordinates">
                        <div class="coordinate">
                          <label>X:</label>
                          <input type="number" [ngModel]="keyframe.translation?.x || 0" 
                                 (input)="onKeyframeTranslationXChange(i, $event)" step="0.1">
                        </div>
                        <div class="coordinate">
                          <label>Y:</label>
                          <input type="number" [ngModel]="keyframe.translation?.y || 0" 
                                 (input)="onKeyframeTranslationYChange(i, $event)" step="0.1">
                        </div>
                      </div>
                    </div>

                    <div class="transform-section">
                      <label>–ü–æ–≤–æ—Ä–æ—Ç (–≥—Ä–∞–¥—É—Å–∏):</label>
                      <input type="number" [ngModel]="(keyframe.rotation || 0)" 
                             (input)="onKeyframeRotationChange(i, $event)" step="1">
                    </div>

                    <div class="transform-section">
                      <label>–ú–∞—Å—à—Ç–∞–±:</label>
                      <div class="coordinates">
                        <div class="coordinate">
                          <label>X:</label>
                          <input type="number" [ngModel]="keyframe.scale?.x || 1" 
                                 (input)="onKeyframeScaleXChange(i, $event)" min="0.1" step="0.1">
                        </div>
                        <div class="coordinate">
                          <label>Y:</label>
                          <input type="number" [ngModel]="keyframe.scale?.y || 1" 
                                 (input)="onKeyframeScaleYChange(i, $event)" min="0.1" step="0.1">
                        </div>
                      </div>
                    </div>

                    <div class="transform-section">
                      <label>–ó—Å—É–≤:</label>
                      <div class="coordinates">
                        <div class="coordinate">
                          <label>X:</label>
                          <input type="number" [ngModel]="keyframe.shear?.x || 0" 
                                 (input)="onKeyframeShearXChange(i, $event)" step="0.1">
                        </div>
                        <div class="coordinate">
                          <label>Y:</label>
                          <input type="number" [ngModel]="keyframe.shear?.y || 0" 
                                 (input)="onKeyframeShearYChange(i, $event)" step="0.1">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Animation controls -->
            <div class="form-actions">
              <button class="save-btn" (click)="saveAnimation()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é</button>
            </div>
          </div>

          <!-- Animated shapes list -->
          <div class="animated-shapes-list" *ngIf="!selectedAnimationShapeId">
            <h4>–§—ñ–≥—É—Ä–∏ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é:</h4>
            <ul *ngIf="getAnimatedShapes().length > 0; else noAnimatedShapes">
              <li *ngFor="let shape of getAnimatedShapes(); let i = index" class="animated-shape-item">
                <div class="shape-info">
                  <span>{{ i + 1 }}. {{ shape.name || shape.type }}</span>
                  <span class="animation-status" [ngClass]="{'playing': shape.animation?.isPlaying}">
                    {{ shape.animation?.isPlaying ? '–í—ñ–¥—Ç–≤–æ—Ä—é—î—Ç—å—Å—è' : '–ó—É–ø–∏–Ω–µ–Ω–æ' }}
                  </span>
                </div>
                <div class="shape-actions">
                  <button class="play-pause-btn" 
                          [ngClass]="{'playing': shape.animation?.isPlaying}"
                          (click)="shape.animation?.isPlaying ? pauseAnimation(shape.id) : playAnimation(shape.id)"
                          title="{{ shape.animation?.isPlaying ? '–ü—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏' : '–í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏' }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                      <path *ngIf="!shape.animation?.isPlaying" d="M8 5v14l11-7z" fill="currentColor"/>
                      <path *ngIf="shape.animation?.isPlaying" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="currentColor"/>
                    </svg>
                  </button>
                  <button class="stop-btn" 
                          (click)="stopAnimation(shape.id)"
                          title="–ó—É–ø–∏–Ω–∏—Ç–∏">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                      <path d="M6 6h12v12H6z" fill="currentColor"/>
                    </svg>
                  </button>
                  <button class="edit-arrow-btn" 
                          (click)="selectShapeForAnimation(shape.id)"
                          title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/>
                    </svg>
                  </button>
                  <button class="delete-cross-btn" 
                          (click)="removeAnimation(shape.id)"
                          title="–í–∏–¥–∞–ª–∏—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é">
                    <svg class="cross-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                    </svg>
                  </button>
                </div>
              </li>
            </ul>
            <ng-template #noAnimatedShapes>
              <p class="no-shapes-message">–ñ–æ–¥–Ω–∞ —Ñ—ñ–≥—É—Ä–∞ —â–µ –Ω–µ –º–∞—î –∞–Ω—ñ–º–∞—Ü—ñ—ó.</p>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Results Popup -->
  <div *ngIf="showResultsPopup" class="results-popup-overlay desktop-only-content">
    <div class="results-popup">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
      <div class="results-content">
        <p class="results-score" *ngIf="taskResultCorrect">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="completed-icon big-icon">
            <path fill="#4caf50" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
          </svg>
          <span class="highlight success">–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å!</span>
        </p>
        
        <!-- Add points animation here -->
        <div *ngIf="taskResultCorrect" class="points-animation-container">
          <div class="points-badge">+{{ selectedTask?.points || 0 }}</div>
        </div>

        <p class="results-score" *ngIf="!taskResultCorrect">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="completed-icon big-icon">
            <path fill="#EB5E28" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
          </svg>
          <span class="highlight error">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å!</span>
        </p>
        <div class="task-message" *ngIf="taskResultCorrect">
          <p>–ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ! –í–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É –∑–∞–≤–¥–∞–Ω—å.</p>
        </div>
        <div class="task-message" *ngIf="!taskResultCorrect">
          <p>–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.</p>
        </div>
      </div>
      <div class="results-actions">
        <button class="retry-btn" *ngIf="!taskResultCorrect" (click)="closeResultsPopup(false)">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ</button>
        <button class="return-btn" (click)="closeResultsPopup(true)">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∑–∞–≤–¥–∞–Ω—å</button>
      </div>
    </div>
  </div>
</div>